#include "BLDC.h"
#include "main.h"
#include "stm32g4xx_it.h"
#include <math.h>

const float SVPWM_table[SVPWM_SIZE] = {0, 52.89979566, 105.7834775, 158.6349367, 211.4380742, 264.1768056, 316.8350661, 369.3968157, 421.8460433, 474.1667726, 526.3430661, 578.3590304, 630.198821, 681.8466468, 733.2867756, 784.5035381, 835.4813333, 886.2046327, 936.6579857, 986.8260235, 1036.693465, 1086.245119, 1135.465892, 1184.340792, 1232.854929, 1280.993528, 1328.741923, 1376.08557, 1423.010049, 1469.501065, 1515.544457, 1530.584487, 1545.158288, 1559.261417, 1572.889581, 1586.038627, 1598.704551, 1610.883494, 1622.571745, 1633.765746, 1644.462086, 1654.657507, 1664.348904, 1673.533323, 1682.207968, 1690.370196, 1698.017521, 1705.147613, 1711.758301, 1717.847571, 1723.413568, 1728.454596, 1732.96912, 1736.955765, 1740.413317, 1743.340722, 1745.737088, 1747.601686, 1748.933947, 1749.733467, 1750, 1749.733467, 1748.933947, 1747.601686, 1745.737088, 1743.340722, 1740.413317, 1736.955765, 1732.96912, 1728.454596, 1723.413568, 1717.847571, 1711.758301, 1705.147613, 1698.017521, 1690.370196, 1682.207968, 1673.533323, 1664.348904, 1654.657507, 1644.462086, 1633.765746, 1622.571745, 1610.883494, 1598.704551, 1586.038627, 1572.889581, 1559.261417, 1545.158288, 1530.584487, 1515.544457, 1530.584487, 1545.158288, 1559.261417, 1572.889581, 1586.038627, 1598.704551, 1610.883494, 1622.571745, 1633.765746, 1644.462086, 1654.657507, 1664.348904, 1673.533323, 1682.207968, 1690.370196, 1698.017521, 1705.147613, 1711.758301, 1717.847571, 1723.413568, 1728.454596, 1732.96912, 1736.955765, 1740.413317, 1743.340722, 1745.737088, 1747.601686, 1748.933947, 1749.733467, 1750, 1749.733467, 1748.933947, 1747.601686, 1745.737088, 1743.340722, 1740.413317, 1736.955765, 1732.96912, 1728.454596, 1723.413568, 1717.847571, 1711.758301, 1705.147613, 1698.017521, 1690.370196, 1682.207968, 1673.533323, 1664.348904, 1654.657507, 1644.462086, 1633.765746, 1622.571745, 1610.883494, 1598.704551, 1586.038627, 1572.889581, 1559.261417, 1545.158288, 1530.584487, 1515.544457, 1469.501065, 1423.010049, 1376.08557, 1328.741923, 1280.993528, 1232.854929, 1184.340792, 1135.465892, 1086.245119, 1036.693465, 986.8260235, 936.6579857, 886.2046327, 835.4813333, 784.5035381, 733.2867756, 681.8466468, 630.198821, 578.3590304, 526.3430661, 474.1667726, 421.8460433, 369.3968157, 316.8350661, 264.1768056, 211.4380742, 158.6349367, 105.7834775, 52.89979566, 2.47569E-13, -52.89979566, -105.7834775, -158.6349367, -211.4380742, -264.1768056, -316.8350661, -369.3968157, -421.8460433, -474.1667726, -526.3430661, -578.3590304, -630.198821, -681.8466468, -733.2867756, -784.5035381, -835.4813333, -886.2046327, -936.6579857, -986.8260235, -1036.693465, -1086.245119, -1135.465892, -1184.340792, -1232.854929, -1280.993528, -1328.741923, -1376.08557, -1423.010049, -1469.501065, -1515.544457, -1530.584487, -1545.158288, -1559.261417, -1572.889581, -1586.038627, -1598.704551, -1610.883494, -1622.571745, -1633.765746, -1644.462086, -1654.657507, -1664.348904, -1673.533323, -1682.207968, -1690.370196, -1698.017521, -1705.147613, -1711.758301, -1717.847571, -1723.413568, -1728.454596, -1732.96912, -1736.955765, -1740.413317, -1743.340722, -1745.737088, -1747.601686, -1748.933947, -1749.733467, -1750, -1749.733467, -1748.933947, -1747.601686, -1745.737088, -1743.340722, -1740.413317, -1736.955765, -1732.96912, -1728.454596, -1723.413568, -1717.847571, -1711.758301, -1705.147613, -1698.017521, -1690.370196, -1682.207968, -1673.533323, -1664.348904, -1654.657507, -1644.462086, -1633.765746, -1622.571745, -1610.883494, -1598.704551, -1586.038627, -1572.889581, -1559.261417, -1545.158288, -1530.584487, -1515.544457, -1530.584487, -1545.158288, -1559.261417, -1572.889581, -1586.038627, -1598.704551, -1610.883494, -1622.571745, -1633.765746, -1644.462086, -1654.657507, -1664.348904, -1673.533323, -1682.207968, -1690.370196, -1698.017521, -1705.147613, -1711.758301, -1717.847571, -1723.413568, -1728.454596, -1732.96912, -1736.955765, -1740.413317, -1743.340722, -1745.737088, -1747.601686, -1748.933947, -1749.733467, -1750, -1749.733467, -1748.933947, -1747.601686, -1745.737088, -1743.340722, -1740.413317, -1736.955765, -1732.96912, -1728.454596, -1723.413568, -1717.847571, -1711.758301, -1705.147613, -1698.017521, -1690.370196, -1682.207968, -1673.533323, -1664.348904, -1654.657507, -1644.462086, -1633.765746, -1622.571745, -1610.883494, -1598.704551, -1586.038627, -1572.889581, -1559.261417, -1545.158288, -1530.584487, -1515.544457, -1469.501065, -1423.010049, -1376.08557, -1328.741923, -1280.993528, -1232.854929, -1184.340792, -1135.465892, -1086.245119, -1036.693465, -986.8260235, -936.6579857, -886.2046327, -835.4813333, -784.5035381, -733.2867756, -681.8466468, -630.198821, -578.3590304, -526.3430661, -474.1667726, -421.8460433, -369.3968157, -316.8350661, -264.1768056, -211.4380742, -158.6349367, -105.7834775, -52.89979566};
const float SPWM_table[SVPWM_SIZE] = {0, 30.54171127, 61.07411923, 91.58792343, 122.0738291, 152.5225498, 182.9248107, 213.271351, 243.5529267, 273.7603138, 303.8843109, 333.9157419, 363.8454589, 393.6643451, 423.3633173, 452.9333289, 482.3653727, 511.6504833, 540.7797402, 569.7442703, 598.5352508, 627.1439117, 655.5615385, 683.7794749, 711.7891254, 739.581958, 767.1495069, 794.4833745, 821.5752349, 848.4168354, 875, 901.3166311, 927.3587124, 953.1183113, 978.5875811, 1003.758764, 1028.624192, 1053.176291, 1077.407582, 1101.310684, 1124.878317, 1148.103301, 1170.978561, 1193.49713, 1215.652148, 1237.436867, 1258.844651, 1279.868978, 1300.503445, 1320.741765, 1340.577775, 1360.005433, 1379.018819, 1397.612143, 1415.77974, 1433.516078, 1450.815752, 1467.673494, 1484.084168, 1500.042776, 1515.544457, 1530.584487, 1545.158288, 1559.261417, 1572.889581, 1586.038627, 1598.704551, 1610.883494, 1622.571745, 1633.765746, 1644.462086, 1654.657507, 1664.348904, 1673.533323, 1682.207968, 1690.370196, 1698.017521, 1705.147613, 1711.758301, 1717.847571, 1723.413568, 1728.454596, 1732.96912, 1736.955765, 1740.413317, 1743.340722, 1745.737088, 1747.601686, 1748.933947, 1749.733467, 1750, 1749.733467, 1748.933947, 1747.601686, 1745.737088, 1743.340722, 1740.413317, 1736.955765, 1732.96912, 1728.454596, 1723.413568, 1717.847571, 1711.758301, 1705.147613, 1698.017521, 1690.370196, 1682.207968, 1673.533323, 1664.348904, 1654.657507, 1644.462086, 1633.765746, 1622.571745, 1610.883494, 1598.704551, 1586.038627, 1572.889581, 1559.261417, 1545.158288, 1530.584487, 1515.544457, 1500.042776, 1484.084168, 1467.673494, 1450.815752, 1433.516078, 1415.77974, 1397.612143, 1379.018819, 1360.005433, 1340.577775, 1320.741765, 1300.503445, 1279.868978, 1258.844651, 1237.436867, 1215.652148, 1193.49713, 1170.978561, 1148.103301, 1124.878317, 1101.310684, 1077.407582, 1053.176291, 1028.624192, 1003.758764, 978.5875811, 953.1183113, 927.3587124, 901.3166311, 875, 848.4168354, 821.5752349, 794.4833745, 767.1495069, 739.581958, 711.7891254, 683.7794749, 655.5615385, 627.1439117, 598.5352508, 569.7442703, 540.7797402, 511.6504833, 482.3653727, 452.9333289, 423.3633173, 393.6643451, 363.8454589, 333.9157419, 303.8843109, 273.7603138, 243.5529267, 213.271351, 182.9248107, 152.5225498, 122.0738291, 91.58792343, 61.07411923, 30.54171127, 2.14401E-13, -30.54171127, -61.07411923, -91.58792343, -122.0738291, -152.5225498, -182.9248107, -213.271351, -243.5529267, -273.7603138, -303.8843109, -333.9157419, -363.8454589, -393.6643451, -423.3633173, -452.9333289, -482.3653727, -511.6504833, -540.7797402, -569.7442703, -598.5352508, -627.1439117, -655.5615385, -683.7794749, -711.7891254, -739.581958, -767.1495069, -794.4833745, -821.5752349, -848.4168354, -875, -901.3166311, -927.3587124, -953.1183113, -978.5875811, -1003.758764, -1028.624192, -1053.176291, -1077.407582, -1101.310684, -1124.878317, -1148.103301, -1170.978561, -1193.49713, -1215.652148, -1237.436867, -1258.844651, -1279.868978, -1300.503445, -1320.741765, -1340.577775, -1360.005433, -1379.018819, -1397.612143, -1415.77974, -1433.516078, -1450.815752, -1467.673494, -1484.084168, -1500.042776, -1515.544457, -1530.584487, -1545.158288, -1559.261417, -1572.889581, -1586.038627, -1598.704551, -1610.883494, -1622.571745, -1633.765746, -1644.462086, -1654.657507, -1664.348904, -1673.533323, -1682.207968, -1690.370196, -1698.017521, -1705.147613, -1711.758301, -1717.847571, -1723.413568, -1728.454596, -1732.96912, -1736.955765, -1740.413317, -1743.340722, -1745.737088, -1747.601686, -1748.933947, -1749.733467, -1750, -1749.733467, -1748.933947, -1747.601686, -1745.737088, -1743.340722, -1740.413317, -1736.955765, -1732.96912, -1728.454596, -1723.413568, -1717.847571, -1711.758301, -1705.147613, -1698.017521, -1690.370196, -1682.207968, -1673.533323, -1664.348904, -1654.657507, -1644.462086, -1633.765746, -1622.571745, -1610.883494, -1598.704551, -1586.038627, -1572.889581, -1559.261417, -1545.158288, -1530.584487, -1515.544457, -1500.042776, -1484.084168, -1467.673494, -1450.815752, -1433.516078, -1415.77974, -1397.612143, -1379.018819, -1360.005433, -1340.577775, -1320.741765, -1300.503445, -1279.868978, -1258.844651, -1237.436867, -1215.652148, -1193.49713, -1170.978561, -1148.103301, -1124.878317, -1101.310684, -1077.407582, -1053.176291, -1028.624192, -1003.758764, -978.5875811, -953.1183113, -927.3587124, -901.3166311, -875, -848.4168354, -821.5752349, -794.4833745, -767.1495069, -739.581958, -711.7891254, -683.7794749, -655.5615385, -627.1439117, -598.5352508, -569.7442703, -540.7797402, -511.6504833, -482.3653727, -452.9333289, -423.3633173, -393.6643451, -363.8454589, -333.9157419, -303.8843109, -273.7603138, -243.5529267, -213.271351, -182.9248107, -152.5225498, -122.0738291, -91.58792343, -61.07411923, -30.54171127};

volatile float pre_pos = 0.0, position = 0, rpm = 0, power = 0;
volatile uint8_t motor_mode = 0;

//FOC Loop
void TIM3_IRQHandler(void) {
	static int16_t cnt, pre_cnt;
	static float diff;
	if(TIM3->SR & 0x1){
		TIM3->SR &= ~(0x1);

		pre_cnt = cnt;
		cnt = -TIM8->CNT;
//		if(diff > ENCODER_RES/2) {
//			diff -= ENCODER_RES;
//		} else if(diff < -ENCODER_RES/2) {
//			diff += ENCODER_RES;
//		}
		diff = ((float)cnt - (float)pre_cnt) / ENCODER_RES * 10000.0f * 60.0f;
		if(fabs(diff) > 10000) {
			diff = rpm;
		}
		rpm = RPM_LPF * rpm + (1.0-RPM_LPF) * diff;

		pre_pos = position;
		position = (float)cnt * 360.0f / ENCODER_RES  - MOTOR_ZERO_ANGLE;
		while(position < 0.0) {
			position += 360.0;
		}
		while(position > 360.0) {
			position -= 360.0;
		}

		if(motor_mode) {
			setPhaseVoltage(power, position * POLE_PAIRS);
		}
	}
}

inline void setPhaseVoltage(float p, float angle_el) {
    static float pwm_u, pwm_v, pwm_w;

    p = p < -1.0 ? -1.0 : p > 1.0 ? 1.0 : p;
    p = -p;

	static int index;

	if(p < 0) {
		angle_el -= PHASE_DIFF;
		p = -p;
	} else {
		angle_el += PHASE_DIFF;
	}

	angle_el = fmod(angle_el, 360.0);
	if(angle_el < 0) {
		angle_el += 360.0;
	}

	index = angle_el;
	index = (index < 0.0) | (index >= SVPWM_SIZE) ? 0 : index;

	pwm_u = (float)SVPWM_table[index] * p;

	index = (index + SVPWM_INCREMENT) % SVPWM_SIZE;
	pwm_v = (float)SVPWM_table[index] * p;

	index = (index + SVPWM_INCREMENT) % SVPWM_SIZE;
	pwm_w = (float)SVPWM_table[index] * p;

	static float center, Umin, Umax;
	center = MAX_PWM / 2.0;
	Umin = fmin(pwm_u, fmin(pwm_v, pwm_w));
	Umax = fmax(pwm_u, fmax(pwm_v, pwm_w));
	center -= (Umax+Umin) / 2;
	pwm_u += center;
	pwm_v += center;
	pwm_w += center;

	set_motor_pwm(pwm_u, pwm_v, pwm_w);
}

void BLDC_phase(unsigned char phase, float p) {
	if(phase == 1) {
		TIM1->CCER |= TIM_CCER_CC1NP;
		TIM1->CCER &= ~TIM_CCER_CC2NP;
		TIM1->CCER &= ~TIM_CCER_CC3NP;
		TIM1->EGR |= TIM_EGR_COMG;
		TIM1->CCR1 = 0;
		TIM1->CCR2 = p;
		TIM1->CCR3 = 0;
	} else if(phase == 2) {
		TIM1->CCER &= ~TIM_CCER_CC1NP;
		TIM1->CCER &= ~TIM_CCER_CC2NP;
		TIM1->CCER |= TIM_CCER_CC3NP;
		TIM1->EGR |= TIM_EGR_COMG;
		TIM1->CCR1 = 0;
		TIM1->CCR2 = p;
		TIM1->CCR3 = 0;
	} else if(phase == 3) {
		TIM1->CCER &= ~TIM_CCER_CC1NP;
		TIM1->CCER |= TIM_CCER_CC2NP;
		TIM1->CCER &= ~TIM_CCER_CC3NP;
		TIM1->EGR |= TIM_EGR_COMG;
		TIM1->CCR1 = 0;
		TIM1->CCR2 = 0;
		TIM1->CCR3 = p;
	} else if(phase == 4) {
 		TIM1->CCER |= TIM_CCER_CC1NP;
 		TIM1->CCER &= ~TIM_CCER_CC2NP;
 		TIM1->CCER &= ~TIM_CCER_CC3NP;
 		TIM1->EGR |= TIM_EGR_COMG;
 		TIM1->CCR1 = 0;
 		TIM1->CCR2 = 0;
 		TIM1->CCR3 = p;
	} else if(phase == 5) {
		TIM1->CCER &= ~TIM_CCER_CC1NP;
		TIM1->CCER &= ~TIM_CCER_CC2NP;
		TIM1->CCER |= TIM_CCER_CC3NP;
		TIM1->EGR |= TIM_EGR_COMG;
		TIM1->CCR1 = p;
		TIM1->CCR2 = 0;
		TIM1->CCR3 = 0;
	} else if(phase == 6) {
		TIM1->CCER &= ~TIM_CCER_CC1NP;
		TIM1->CCER |= TIM_CCER_CC2NP;
		TIM1->CCER &= ~TIM_CCER_CC3NP;
		TIM1->EGR |= TIM_EGR_COMG;
		TIM1->CCR1 = p;
		TIM1->CCR2 = 0;
		TIM1->CCR3 = 0;
	}
}

void set_motor_pwm(uint16_t u, uint16_t v, uint16_t w) {
	u = u < 0 ? 0 : u;
	u = u > MAX_PWM ? MAX_PWM : u;

	v = v < 0 ? 0 : v;
	v = v > MAX_PWM ? MAX_PWM : v;

	w = w < 0 ? 0 : w;
	w = w > MAX_PWM ? MAX_PWM : w;

	TIM1->CCR1 = u;
	TIM1->CCR2 = v;
	TIM1->CCR3 = w;
}

void motor_on() {
	TIM1->CCER &= ~TIM_CCER_CC1NP;
	TIM1->CCER &= ~TIM_CCER_CC2NP;
	TIM1->CCER &= ~TIM_CCER_CC3NP;
}

void motor_off() {
	TIM1->CCER |= TIM_CCER_CC1NP;
	TIM1->CCER |= TIM_CCER_CC2NP;
	TIM1->CCER |= TIM_CCER_CC3NP;
	TIM1->CCR1 = 0;
	TIM1->CCR2 = 0;
	TIM1->CCR3 = 0;
}
